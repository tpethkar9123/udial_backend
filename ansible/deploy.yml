---
- name: Deploy uDIAL Backend Stack with Dockerized Nginx & Monitoring
  hosts: ec2
  become: true
  vars:
    app_dir: "/home/ubuntu/udial-backend"
    domain: "mytestapi.xyz"
    email: "tusharpethkar9123@gmail.com"

  tasks:
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install Docker & Dependencies
      ansible.builtin.apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - software-properties-common
          - gnupg
          - certbot
        state: present

    - name: Add Docker GPG apt Key
      ansible.builtin.apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Add Docker repository
      ansible.builtin.apt_repository:
        repo: deb [arch=amd64] https://download.docker.com/linux/ubuntu focal stable
        state: present

    - name: Install Docker Engine & Compose Plugin
      ansible.builtin.apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-compose-plugin
        state: present

    - name: Ensure app and config directories exist
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: "0755"
      loop:
        - "{{ app_dir }}"
        - "{{ app_dir }}/nginx"
        - "{{ app_dir }}/prometheus"

    - name: Write Prometheus Configuration
      ansible.builtin.copy:
        dest: "{{ app_dir }}/prometheus/prometheus.yml"
        owner: ubuntu
        group: ubuntu
        mode: "0644"
        content: |
          global:
            scrape_interval: 15s
          scrape_configs:
            - job_name: 'prometheus'
              static_configs:
                - targets: ['localhost:9090']
            - job_name: 'api'
              static_configs:
                - targets: ['api:3000']

    - name: Write Nginx Configuration
      ansible.builtin.copy:
        dest: "{{ app_dir }}/nginx/nginx.conf"
        owner: ubuntu
        group: ubuntu
        mode: "0644"
        content: |
          events {}
          http {
            resolver 127.0.0.11 valid=10s;
            
            upstream api {
              least_conn;
              server api:3000 max_fails=3 fail_timeout=30s;
            }

            server {
              listen 80;
              server_name {{ domain }} localhost;
              
              location /.well-known/acme-challenge/ {
                  root /var/www/certbot;
              }

              proxy_next_upstream error timeout http_502 http_503 http_504;
              proxy_next_upstream_tries 2;
              proxy_next_upstream_timeout 10s;
              
              proxy_connect_timeout 5s;
              proxy_read_timeout 60s;
              proxy_send_timeout 60s;

              location /health {
                proxy_pass http://api/api/health;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
              }

              location / {
                proxy_pass http://api;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
              }

              # Proxy Grafana
              location /grafana/ {
                proxy_pass http://grafana:3000/;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
              }
            }
          }

    - name: Write docker-compose.udial.yml
      ansible.builtin.copy:
        dest: "{{ app_dir }}/docker-compose.udial.yml"
        owner: ubuntu
        group: ubuntu
        mode: "0644"
        content: |
          services:
            nginx:
              image: nginx:alpine
              ports:
                - "80:80"
                - "443:443"
              volumes:
                - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
                - /etc/letsencrypt:/etc/letsencrypt:ro
                - /var/www/certbot:/var/www/certbot:ro
              depends_on:
                - api
              networks:
                - udial

            api:
              image: tpethkar/udial-backend:latest
              env_file: .env
              environment:
                CLERK_JWT_KEY: |
                  -----BEGIN PUBLIC KEY-----
                  MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAtaITRlX+vzq98wm0Hs+0
                  F1EKmG2REfrvA9aO8uPVb7yZrlodLByH+BDjzPxALhTO4DPC5b2HtUMwPK1Asjuu
                  eIreeo7OK0tayL9/sx0rbCoWkLmqf/ekSMg+A4hQoRZJLRJ/KrebNyc9j4GH/X6Z
                  Ul81U47QdRqZ7I3yNehF1mUr74PWPbgtJjGrqoHLrzkA17tQyRUhnE3U0sTUYfzk
                  bq2us/Y40w93x/AmMR0J+xQz3W+KtiPwF8sgyAlae6c/uf4C7+jAUSMBYp+3XT09
                  Sgi1qOswPvdqCxlxwk/v4njUxit/PSMNUD8xTGyRlXyrEKXrCrshRj0Sf/IGuPf+
                  0QIDAQAB
                  -----END PUBLIC KEY-----
                REDIS_URL: redis://redis:6379
              expose:
                - "3000"
              deploy:
                replicas: 2
              depends_on:
                - redis
              networks:
                - udial

            worker:
              image: tpethkar/udial-backend:latest
              command: ["node", "dist/main-worker.js"]
              env_file: .env
              environment:
                REDIS_URL: redis://redis:6379
              depends_on:
                - redis
              networks:
                - udial

            redis:
              image: redis:7-alpine
              ports:
                - "6379:6379"
              volumes:
                - redis_data:/data
              networks:
                - udial

            prometheus:
              image: prom/prometheus:latest
              container_name: prometheus
              volumes:
                - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
                - prometheus_data:/prometheus
              command:
                - "--config.file=/etc/prometheus/prometheus.yml"
                - "--storage.tsdb.path=/prometheus"
              ports:
                - "9090:9090"
              networks:
                - udial

            grafana:
              image: grafana/grafana:latest
              container_name: grafana
              ports:
                - "3001:3000"
              volumes:
                - grafana_data:/var/lib/grafana
              environment:
                - GF_SECURITY_ADMIN_PASSWORD=admin
                - GF_USERS_ALLOW_SIGN_UP=false
                - GF_SERVER_ROOT_URL=%(protocol)s://%(domain)s:%(http_port)s/grafana/
                - GF_SERVER_SERVE_FROM_SUB_PATH=true
              depends_on:
                - prometheus
              networks:
                - udial

          volumes:
            redis_data:
            prometheus_data:
            grafana_data:

          networks:
            udial:
              driver: bridge

    - name: Write .env file
      ansible.builtin.copy:
        dest: "{{ app_dir }}/.env"
        owner: ubuntu
        group: ubuntu
        mode: "0600"
        content: |
          DATABASE_URL="postgresql://udial_admin:Password123!@udial-rds.c7y6okmu6tl3.ap-south-1.rds.amazonaws.com:5432/udial"
          AWS_REGION="ap-south-1"
          AWS_ACCESS_KEY_ID="AKIAQFC27HUV6OE23FP5"
          AWS_SECRET_ACCESS_KEY="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"
          AWS_S3_BUCKET="udial-uploads-tushar-2026"
          REDIS_URL="redis://redis:6379"
          EC2_PUBLIC_IP="13.232.36.255"
          CLERK_SECRET_KEY="sk_test_CWq0wACywggb9iAia03nDyW3970ITjJiOm2XHO9kPK"

    - name: Ensure Certbot challenge directory exists on host
      ansible.builtin.file:
        path: /var/www/certbot
        state: directory
        mode: "0755"

    - name: Deploy uDIAL Stack
      ansible.builtin.shell: |
        docker compose -f docker-compose.udial.yml down || true
        docker compose -f docker-compose.udial.yml pull
        docker compose -f docker-compose.udial.yml up -d
      args:
        chdir: "{{ app_dir }}"

    - name: Obtain SSL certificates with Certbot (Webroot mode)
      ansible.builtin.command: >
        certbot certonly --webroot -w /var/www/certbot
        --non-interactive --agree-tos --email {{ email }}
        -d {{ domain }}
      register: certbot_result
      ignore_errors: true

    - name: Apply SSL config to Nginx if Certbot succeeded
      ansible.builtin.copy:
        dest: "{{ app_dir }}/nginx/nginx.conf"
        owner: ubuntu
        group: ubuntu
        mode: "0644"
        content: |
          events {}
          http {
            resolver 127.0.0.11 valid=10s;
            
            upstream api {
              least_conn;
              server api:3000 max_fails=3 fail_timeout=30s;
            }

            server {
              listen 80;
              server_name {{ domain }};
              return 301 https://$host$request_uri;
            }

            server {
              listen 443 ssl http2;
              server_name {{ domain }};

              ssl_certificate /etc/letsencrypt/live/{{ domain }}/fullchain.pem;
              ssl_certificate_key /etc/letsencrypt/live/{{ domain }}/privkey.pem;

              location /health {
                proxy_pass http://api/api/health;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
              }

              location / {
                proxy_pass http://api;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
              }

              # Proxy Grafana
              location /grafana/ {
                proxy_pass http://grafana:3000/;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
              }
            }
          }
      when: certbot_result is succeeded

    - name: Restart Nginx container to apply potential SSL
      ansible.builtin.shell: docker compose -f docker-compose.udial.yml restart nginx
      args:
        chdir: "{{ app_dir }}"
      when: certbot_result is succeeded
